#!/bin/bash
# envrc

# XDG
export XDG_CONFIG_HOME="${HOME}/.config"
export XDG_CACHE_HOME="${HOME}/.cache"
export XDG_DATA_HOME="${HOME}/.local/share"
export XDG_STATE_HOME="${HOME}/.local/state"
#export XDG_DOCUMENTS_DIR="${HOME}/doc"
#export XDG_DOWNLOAD_DIR="${HOME}/dow"

# runtime dir
idu="$(id -u)"
export XDG_RUNTIME_DIR="/run/user/$idu"
# export XDG_RUNTIME_DIR="${HOME}/.local/runtime"

# zsh shell
export ZDOTDIR="${XDG_CONFIG_HOME}/shell"

# ripgrep config file
export RIPGREP_CONFIG_PATH="${XDG_CONFIG_HOME}/ripgrep/rc"

# gpg
# export GPG_TTY="$(tty)"
export GNUPGHOME="${XDG_CONFIG_HOME}/gnupg"

# gtk-2.0 config file
export GTK2_RC_FILES="${XDG_CONFIG_HOME}/gtk-2.0/config"

# development
export C_INCLUDE_PATH="${HOME}/.local/include"
export LD_LIBRARY_PATH="${HOME}/.local/lib"
export PKG_CONFIG_PATH="${HOME}/.local/lib/pkgconfig"

# R
export R_HOME_USER="${XDG_DATA_HOME}/R"
export R_LIBS_USER="${HOME}/.local/lib/R"
export R_ENVIRON_USER="${XDG_CONFIG_HOME}/R/renviron"
export R_PROFILE_USER="${XDG_CONFIG_HOME}/R/rprofile"
export R_HISTFILE="${XDG_DATA_HOME}/R/rhistory"

# paths
export MANPATH="/usr/share/man:${HOME}/.local/share/man"
export PATH="${PATH}:${HOME}/.local/bin:${HOME}/.cargo/bin"

# less history
export LESSHISTFILE="$XDG_DATA_HOME/less/lesshst"

# runit
# export SVDIR="$XDG_CONFIG_HOME"/service

# NNN
export NNN_OPTS='eEHr'
export NNN_COLORS='3415'
export NNN_FCOLORS='070704030f05060808010301'
export NNN_TRASH=1
# export NNN_ARCHIVE="\\.(7z|a|ace|alz|arc|arj|bz|bz2|cab|cpio|deb|gz|jar|lha|lz|lzh|lzma|lzo|rar|rpm|rz|t7z|tar|tbz|tbz2|tgz|tlz|txz|tZ|tzo|war|xpi|xz|Z|zip)$"
# without rar
export NNN_ARCHIVE="\\.(7z|a|ace|alz|arc|arj|bz|bz2|cab|cpio|deb|gz|jar|lha|lz|lzh|lzma|lzo|rpm|rz|t7z|tar|tbz|tbz2|tgz|tlz|txz|tZ|tzo|war|xpi|xz|Z|zip)$"
export NNN_SEL='/tmp/.sel'
export NNN_FIFO='/tmp/nnn.fifo'

NNN_BMS_CONFIG='c:~/.config;l:~/.local'
NNN_BMS_DEV='v:~/dev'
NNN_BMS_DOC='d:~/doc'
NNN_BMS_DOW='w:~/dow'
export NNN_BMS="$NNN_BMS_CONFIG;$NNN_BMS_DEV;$NNN_BMS_DOC;$NNN_BMS_DOW"

NNN_PLUG_EDIT='c:cmx;e:exec'
NNN_PLUG_FUZZY='f:fzfd;h:fzhist;a:autojump'
NNN_PLUG_OPEN='u:doasedit;o:open-editor;i:imgview;d:dragdrop;m:nmount'
NNN_PLUG_GIT='l:!git log;s:!git status'
export NNN_PLUG="$NNN_PLUG_EDIT;$NNN_PLUG_FUZZY;$NNN_PLUG_OPEN;$NNN_PLUG_GIT"

# fzf
# gruvbox hard dark color and other default options
export FZF_DEFAULT_OPTS='--color=bg+:#1d2021,bg:#1d2021,spinner:#fb4934,hl:#928374,fg:#ebdbb2,header:#928374,info:#8ec07c,pointer:#fb4934,marker:#fb4934,fg+:#ebdbb2,prompt:#fb4934,hl+:#fb4934 --reverse --margin 2% --cycle --multi --ansi --no-height --preview "bat --style=numbers --color=always --line-range :500 {}"'
export FZF_DEFAULT_COMMAND='fd --type file --follow --hidden -E .git --color=always'
# Uses tree command to show the entries of the directory
export FZF_ALT_C_OPTS="--preview 'tree -C {} | head -200'"

# Use fd (https://github.com/sharkdp/fd) instead of the default find
# command for listing path candidates.
# - The first argument to the function ($1) is the base path to start traversal
# - See the source code (completion.{bash,zsh}) for the details.
_fzf_compgen_path() {
  fd --hidden --follow --exclude ".git" . "$1"
}

# Use fd to generate the list for directory completion
_fzf_compgen_dir() {
  fd --type d --hidden --follow --exclude ".git" . "$1"
}

# set wayland environment variables and start river
if [ "$(id -u)" -ne 0 ] && [ -z "${WAYLAND_DISPLAY}" ] && [ "$(tty)" = "/dev/tty1" ]; then
	# session and desktop
	export XDG_SESSION_TYPE=wayland
	export XDG_SESSION_DESKTOP=river
	export XDG_CURRENT_DESKTOP=river
	export DESKTOP_SESSION=river

	# for multi-gpu setup
	# export WLR_DRM_DEVICES=/dev/dri/card0

	# seat management
	# seatd is more minimal
	export LIBSEAT_BACKEND=seatd
	# export LIBSEAT_BACKEND=logind

	# QT
	export QT_QPA_PLATFORM=wayland-egl
	export QT_WAYLAND_DISABLE_WINDOWDECORATION=1

	# SDL
	export SDL_VIDEODRIVER=wayland
	# if no sound in SDL applications
	# export SDL_AUDIODRIVER=alsa
	
	# Clutter
	# export CLUTTER_BACKEND=wayland

	# Elementary/EFL
	# export ECORE_EVAS_ENGINE=wayland_egl
	# export ELM_ENGINE=wayland_egl
	# export ELM_DISPLAY=wl
	# export ELM_ACCEL=opengl

	# Mozilla
	export MOZ_ENABLE_WAYLAND=1
	# Open links in external applications in Firefox
	# export MOZ_DBUS_REMOTE=1

	# needed for some Java applications
	# export _JAVA_AWT_WM_NONREPARENTING=1
	
	export BROWSER=firefox
	# export BROWSER="${HOME}/.local/bin/ungoogled_chromium.sh"

	# set GTK theme
	# export GTK_THEME=Adwaita:dark

	# Cursor
	# remember to change also in river (.config/river/init)
	# remember to change also .icons/default/index.theme
	export XCURSOR_THEME=Adwaita
	export XCURSOR_SIZE=20
	
	# wob pipe directory
	export WOB_PIPE="/tmp/wobpipe"
	export WOB_PIPE_CENTER="/tmp/wobpipe-center"

	# finally start river with a dbus-session
	exec dbus-run-session river
fi
