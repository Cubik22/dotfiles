#!/bin/sh

user="$USER"
hostname="$(cat /etc/hostname)"
doas_ask_password="doas ($user@$hostname) password: "

printf "%s" "$doas_ask_password"
stty -echo
read -r password
stty echo
printf "\n"

result="$(/usr/bin/expect <<EOF
spawn doas -- sv status bluetoothd
expect "$doas_ask_password" {send -- "$password\r"}
expect eof
EOF
)"
last_line="$(echo "$result" | tail -n 1)"
case "$last_line" in
    *"Authentication failed"*)
        echo "$last_line"
        return 1
    ;;
esac

bluetoothd_status="$(echo "$last_line" | sed 's/:.*//')"
case "$bluetoothd_status" in
    run)
        bluetoothctl power off || return 1
    ;;
    down)
        echo "bluetoothd is already down"
        return 0
    ;;
    *)
        echo "error: bluetooth status not recognized"
        return 1
    ;;
esac

result="$(/usr/bin/expect <<EOF
spawn doas -- sv down bluetoothd
expect "$doas_ask_password" {send -- "$password\r"}
expect eof
EOF
)"
number_lines="$(echo "$result" | wc -l)"
if [ "$number_lines" -ne 2 ]; then
    echo "error: sv down bluetoothd"
    return 1
else
    echo "success: sv down bluetoothd"
fi
