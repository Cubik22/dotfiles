#!/bin/sh

# add a bookmark

if [ "$#" -eq 0 ]; then
    mode="normal"
else
    case "$1" in
        --normal) mode="normal" ;;
        --copy) mode="copy" ;;
        --repository) mode="repo" ;;
        --wiki) mode="wiki" ;;
        *)
            echo "error: wrong parameter"
            return 1
        ;;
    esac
fi

bookmarks_dir="${XDG_LOCAL_HOME:=$HOME/.local}/etc/bookmarks"
cd "$bookmarks_dir" || return 1

export FZF_DEFAULT_COMMAND="$FZF_DEFAULT_COMMAND --type file"
file="$(fzf)"

[ ! -f "$file" ] && return 1

# remove / from end of url
url="$("$PASTE_CMD" -n | sed 's/\/$//')"

if [ "$mode" = "normal" ]; then
    # ask name to user
    printf "%s" "bookmark name: "
    read -r name
elif [ "$mode" = "copy" ]; then
    # name is the same as url without https?
    name="$(echo "$url" | sed 's/^http\(s\|\):\/\///')"
elif [ "$mode" = "repo" ]; then
    # name is <user>/<project>
    name="$(echo "$url" | rev | cut -d "/" -f 1-2 | rev)"
elif [ "$mode" = "wiki" ]; then
    # url/wiki/stf/<name>
    name="$(echo "$url" | rev | cut -d "/" -f 1 | rev)"
fi

printf "%s" "$url" >> "$file"
printf " %s\n" "$name" >> "$file"

# make sure file ends with newline
# test "$(tail -c 1 "$file" | wc -l)" -eq 0 && printf "\n" >> "$file"
