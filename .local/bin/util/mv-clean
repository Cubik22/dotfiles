#!/bin/sh

info=$(cat << EOF
mv-clean target [target ...]
change spaces with dashes and turn to lower case
remove characters not used in files
EOF
)

if [ "$#" -ne 0 ]; then
    case "$1" in
        -h|--help)
            echo "$info"
            return 0
        ;;
    esac
else
    file="$( \
        $FZF_DEFAULT_COMMAND \
        --type=file \
        --type=symlink \
        --exact-depth 1 \
        '.*pdf$|.*epub$|.*ps$|.*cbz$|.*cbr$|.*djvu$|.*djv$' | \
        fzf \
        --prompt "${FZF_BEFORE_PROMPT}clean: " \
    )"
    [ -z "$file" ] && return 0
    set -- "$file"
fi

for target in "$@"; do
    rename="$( \
        echo "$target" | \
        tr ' ' '-' | \
        tr '_' '-' | \
        tr '[:upper:]' '[:lower:]' | \
        tr -d '(' | \
        tr -d ')' | \
        tr -d '[' | \
        tr -d ']' | \
        tr -d '{' | \
        tr -d '}' | \
        tr -d ',' | \
        tr -d ';' | \
        tr -d ':' | \
        sed 's/^-\+//' | \
        sed 's/-\+/-/g' \
    )"

    if [ ! "$rename" = "$target" ]; then
        mv "$target" "$rename"
    else
        echo "$target is already clean"
    fi
done
