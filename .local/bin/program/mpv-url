#!/bin/sh

# play url with mpv
# optional: use ytdl mode and pass quality

# it is executed in the background
set_fullscreen() {
    # wait for mpv to load
    sleep 10
    riverctl toggle-fullscreen
}

print_info=$(cat << EOF
SYNOPSIS
        mpv-url [option]... url

DESCRIPTION
        play url with mpv
        optionally specifying quality
        if quality is not available play
        with default quality

        -h, --help
            print this info and exit

        -f, --fullscreen
            set mpv window fullscreen

        -a, --audio
            open mpv without video

        -o, --keep-open
            keep the window open

        --best
            use ytdl with best quality

        --medium
            use ytdl with medium quality

        --worst
            use ytdl with worst quality

        --no-ytdl
            do not use ytdl mode (default)
EOF
)

fullscreen=false
audio=false
open=false
quality=false

for param in "$@"; do
    case "$param" in
        -h|--help)
            echo "$print_info"
            return 0
        ;;
        -f|--fullscreen)
            fullscreen=true
        ;;
        -a|--audio)
            audio=true
        ;;
        -o|--keep-open)
            open=true
        ;;
        --best)
            quality="best"
        ;;
        --medium)
            quality="medium"
        ;;
        --worst)
            quality="worst"
        ;;
        --no-ytdl)
            quality=false
        ;;
        *)
            url="$param"
        ;;
    esac
done

if [ "$fullscreen" = "true" ]; then
    set_fullscreen &
fi

ytdl_program="${YTDL:-yt-dlp}"
parameters="--force-window=yes --ytdl=yes \
--script-opts=osc-visibility=never,ytdl_hook-ytdl_path=$ytdl_program"
# parameters="--ytdl-raw-options=no-check-certificate="

if [ "$audio" = "true" ]; then
    parameters="$parameters --video=no --script-opts=osc-visibility=always"
fi

if [ "$open" = "true" ]; then
    parameters="$parameters --keep-open=yes"
else
    parameters="$parameters --keep-open=no"
fi

case "$quality" in
    best)
        ytdl_format="best"
    ;;
    medium)
        ytdl_format="best[height<=480]"
    ;;
    worst)
        ytdl_format="worst"
    ;;
esac

# check if format is available
if [ -n "$ytdl_format" ]; then
    if $ytdl_program --simulate --format="$ytdl_format" "$url" >/dev/null 2>&1; then
        # shellcheck disable=SC2089
        parameters="$parameters --ytdl-format=\\\"$ytdl_format\\\""
    fi
fi

echo "parameters passed to mpv:"
echo "$parameters"
echo

# shellcheck disable=SC2086
# shellcheck disable=SC2090
mpv $parameters "$url"
