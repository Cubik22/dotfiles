#!/bin/sh

# update programs aside from distro package manager

program_names=$(cat << EOF
all
plugins
rustup
cargo
zigup
go
luarocks
pip
npm
R
EOF
)

print_info=$(cat << EOF
SYNOPSIS
        update-extra [option]... program_name

DESCRIPTION
        update programs aside from distro package manager

        -d, --dependencies
            update also dependencies (default)

        -c, --no-dependencies
            do not update dependencies
            by default it also update dependencies

        -h, --help
            print this info and exit

PROGRAMS AVAILABLE:

all means all programs

$program_names
EOF
)

if [ "$#" -lt 1 ]; then
    echo "error: no parameters"
    echo
    echo "$print_info"
    return 1
fi

dep=true

for param in "$@"; do
    if [ "$param" = "-h" ] || [ "$param" = "--help" ]; then
        echo "$print_info"
        return 0
    elif [ "$param" = "-d" ] || [ "$param" = "--dependencies" ]; then
        dep=true
    elif [ "$param" = "-c" ] || [ "$param" = "--no-dependencies" ]; then
        dep=false
    else
        found="false"
        while read -r pack; do
            if [ "$param" = "$pack" ]; then
                found="true"
                break
            fi
        done <<EOT
$program_names
EOT
        if [ "$found" = "true" ]; then
            program="$pack"
            break
        else
            echo "wrong parameter: $param"
            echo "program not available"
            echo
            echo "$print_info"
            return 1
        fi
    fi
done

#### update functions

## plugins
# update kak and mpv plugins
plugins_update() {
    kak-plugins-update
    mpv-plugins-update
    weechat-plugins-update
}

## rustup
# stable toolchain
rustup_update() {
    # global
    doas rustup update

    # local
    export RUSTUP_HOME="$XDG_LIB_HOME/rustup"
    export CARGO_HOME="$XDG_LIB_HOME/cargo"
    rustup update
}

## cargo
cargo_update() {
    # global
    doas cargo install-update --all

    # local
    export RUSTUP_HOME="$XDG_LIB_HOME/rustup"
    export CARGO_HOME="$XDG_LIB_HOME/cargo"
    cargo install-update --all
}

## zigup
# master branch
zigup_update() {
    zigup --install-dir "$XDG_LIB_HOME/zigup" fetch master
}

## go
go_update() {
    doas go install golang.org/x/tools/gopls@latest
}

## luarocks
luarocks_update() {
    doas luarocks list --outdated
    echo "doas luarocks install {package}"
}

## pip
pip_update() {
    doas pip list --outdated
    echo "doas pip install {package}"
}

## npm
npm_update() {
    doas npm -g update
}

## R
R_update() {
    rupdate=$(cat << EOF
# set CRAN mirror
local({
  r <- getOption("repos")
  r["CRAN"] <- "https://cloud.r-project.org/"
  options(repos = r)
})

# update packages
update.packages()
EOF
)
    Rscript -e "$rupdate"
}

#### update program

# substitute '-' with '_'
# posix shell does not support '-' inside function names
program="$(echo "$program" | sed 's/-/_/g')"

if [ "$program" = "all" ]; then
    while read -r pack; do
        eval "${pack}_update"
    done <<EOT
$program_names
EOT
else
    if [ "$dep" = "false" ]; then
        eval "${program}_update"
    else
        eval "${program}_update dep"
    fi
fi
